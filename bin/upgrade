#!/usr/bin/env bash

# ======================================================================================
#
#         FILE:  upgrade
#
#        USAGE:  ./upgrade
#
#  DESCRIPTION:  Update system's linux, python, and pip packages.
#
#      OPTIONS:  ---
# REQUIREMENTS:  ---
#         BUGS:  ---
#        NOTES:  ---
#       AUTHOR:  Henry Mai <henryfromvietnam@gmail.com>
#      COMPANY:  ---
#      VERSION:  1.0
#      CREATED:  2023-05-02
#     REVISION:  ---
#
# ======================================================================================


source "${DOTFILES}"/bash/functions

clear

log_task "Check for updates to the Operating System ..."
sudo apt update
yes | sudo apt dist-upgrade
yes | sudo apt full-upgrade
yes | sudo apt autoremove
sudo apt autoclean

check_command() {
  [[ ! -x "$(command -v "${1}")" ]] \
    && log_manual_action "This script requires ${1}!" \
    && exit 1
}

check_command "python3"
check_command "pip"
check_command "pip-review"
check_command "npm"
check_command "go-global-update"
check_command "cowsay"

log_task "Check for updates to pip packages ..."
pip install --upgrade --user pip setuptools wheel pip-review
"${HOME}"/.local/bin/pip-review --local --auto 2> /tmp/upgrade-error.txt
[[ -s /tmp/upgrade-error.txt ]] \
  && log_error 'pip packages conflict ➡️ "/tmp/upgrade-error.txt"' \
  && sed -i '1d' /tmp/upgrade-error.txt

log_task "Update npm packages ..."
npm install --global npm@latest
npm update --global

log_task "Update go packages ..."
go-global-update

log_task "Update docker images ..."
docker images | grep -v REPOSITORY | awk '{print $1}'| xargs -L1 docker pull

log_task "Remove unused docker images ..."
docker image prune -f

cowsay You are up to date!
